<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orange Pi Solar Charger Control</title>
    
    <!-- Bootstrap 5 CSS desde CDN m√°s estable -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome 6 desde CDN m√°s estable -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Chart.js desde CDN m√°s estable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Custom CSS -->
    <style>
        body {
            background-color: #f0f2f5;
            color: #333;
        }
        .navbar {
            background-color: #2c3e50;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .navbar-brand {
            color: white !important;
            font-weight: bold;
        }
        .navbar-brand .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            border: 1px solid rgba(255,255,255,0.5);
            animation: pulse 1.5s infinite;
        }
        .navbar-brand .status-indicator.connected {
            background-color: #28a745;
        }
        .navbar-brand .status-indicator.disconnected {
            background-color: #dc3545;
        }
        .navbar-brand .status-indicator.warning {
            background-color: #ffc107;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40,167,69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40,167,69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40,167,69, 0); }
        }
        .status-indicator.disconnected { 
            animation: none !important; 
        }
        .status-indicator.warning { 
            animation: pulse-warning 1.5s infinite; 
        }
        @keyframes pulse-warning {
            0% { box-shadow: 0 0 0 0 rgba(255,193,7, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255,193,7, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255,193,7, 0); }
        }

        .container {
            margin-top: 20px;
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,.05);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #34495e;
            color: white;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .nav-tabs .nav-link.active {
            background-color: #34495e;
            color: white;
            border-color: #34495e;
        }
        .nav-tabs .nav-link {
            color: #555;
        }
        .metric-card .card-body {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .metric-card .metric-icon {
            font-size: 2.5rem;
            color: #3498db;
        }
        .metric-card .metric-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        .metric-card .metric-unit {
            font-size: 1rem;
            color: #777;
        }
        .metric-card .metric-label {
            font-size: 1.1rem;
            color: #555;
            margin-top: 5px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .form-label {
            font-weight: bold;
        }
        .footer {
            margin-top: 40px;
            padding: 20px;
            text-align: center;
            color: #777;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
        }
        .alert-fixed {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 250px;
        }
        .log-display {
            height: 400px;
            overflow-y: scroll;
            background-color: #2b2b2b;
            color: #f8f8f2;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85em;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
        }
        .card.config-section {
            margin-bottom: 15px;
        }
        .card.config-section .card-header {
            cursor: pointer;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card.config-section .card-header h5 {
            margin-bottom: 0;
            color: white;
        }
        .card.config-section .card-body {
            display: none;
            padding: 15px;
            border-top: 1px solid #eee;
        }
        .card.config-section.expanded .card-body {
            display: block;
        }
        .card.config-section .card-header .fa-chevron-down,
        .card.config-section .card-header .fa-chevron-up {
            transition: transform 0.3s ease;
        }
        .card.config-section.expanded .card-header .fa-chevron-down {
            transform: rotate(180deg);
        }
        
        /* Fallback styles si no cargan los iconos */
        .fallback-icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            margin-right: 0.5em;
        }
        .fallback-icon.dashboard::before { content: "üìä"; }
        .fallback-icon.config::before { content: "‚öôÔ∏è"; }
        .fallback-icon.load::before { content: "üí°"; }
        .fallback-icon.logs::before { content: "üìã"; }
        .fallback-icon.tools::before { content: "üîß"; }
        .fallback-icon.battery::before { content: "üîã"; }
        .fallback-icon.sun::before { content: "‚òÄÔ∏è"; }
        .fallback-icon.thermometer::before { content: "üå°Ô∏è"; }
    
        /* ===== CRON√ìMETRO VISUAL - AGREGAR AL FINAL DEL <style> EXISTENTE ===== */

    /* Estilos para el cron√≥metro */
    .countdown-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        color: white;
        margin: 20px 0;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .countdown-timer {
        font-size: 3rem;
        font-weight: bold;
        font-family: 'Courier New', monospace;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        margin: 15px 0;
        letter-spacing: 2px;
    }

    .countdown-label {
        font-size: 1.2rem;
        margin-bottom: 10px;
        opacity: 0.9;
    }

    .countdown-status {
        font-size: 1rem;
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 16px;
        border-radius: 20px;
        display: inline-block;
        margin-top: 10px;
    }

    .progress-ring {
        transform: rotate(-90deg);
        margin: 20px auto;
    }

    .progress-ring-circle {
        transition: stroke-dashoffset 1s ease-in-out;
        stroke: #fff;
        stroke-width: 4;
        fill: transparent;
        opacity: 0.8;
    }

    .countdown-controls {
        margin-top: 15px;
    }

    .countdown-controls button {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        margin: 0 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .countdown-controls button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    /* Animaci√≥n pulsante para estado cr√≠tico */
    @keyframes pulse-critical {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .countdown-critical {
        animation: pulse-critical 1s infinite;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%) !important;
    }

    /* Estilos para diferentes estados */
    .countdown-normal {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .countdown-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .countdown-inactive {
        background: linear-gradient(135deg, #a8a8a8 0%, #7d7d7d 100%);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .countdown-timer {
            font-size: 2.5rem;
        }
        .countdown-container {
            padding: 15px;
        }
    }

    @media (max-width: 480px) {
        .countdown-timer {
            font-size: 2rem;
        }
        .countdown-label {
            font-size: 1rem;
        }
    }

    /* ===== FIN DE ESTILOS DEL CRON√ìMETRO ===== */
    

        .night-scheduler {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .night-timer {
            font-size: 2.5rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .night-status {
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.15);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin: 10px 0;
        }

        .schedule-info {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .schedule-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 5px;
            flex: 1;
            min-width: 200px;
        }

        .schedule-item h4 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            opacity: 0.8;
        }

        .schedule-item .time {
            font-size: 1.5rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .night-active {
            background: linear-gradient(135deg, #1a252f 0%, #2c3e50 100%);
            border: 2px solid #3498db;
        }

        .night-waiting {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .night-disabled {
            background: linear-gradient(135deg, #7f8c8d 0%, #95a5a6 100%);
        }

        .night-controls {
            margin-top: 20px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin: 0 10px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #3498db;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .fallback-icon.moon::before { content: "üåô"; }

        /* ===== FIN PROGRAMACI√ìN NOCTURNA ===== */


        .config-section {
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }

        .config-section .card-header {
            cursor: pointer;
            padding: 12px 20px;
            background-color: #34495e;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
            transition: background-color 0.3s ease;
        }

        .config-section .card-header:hover {
            background-color: #2c3e50;
        }

        .config-section .card-header h5 {
            margin: 0;
            font-size: 1.1rem;
        }

        .config-section .toggle-icon {
            font-size: 0.9rem;
            transition: transform 0.3s ease;
        }

        .config-section.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .config-section .card-body {
            display: none;
            padding: 20px;
            background-color: #fff;
            border-radius: 0 0 8px 8px;
        }

        .config-section.expanded .card-body {
            display: block;
        }

        .form-check-input:checked {
            background-color: #34495e;
            border-color: #34495e;
        }

        .save-param-btn {
            background-color: #27ae60;
            border-color: #27ae60;
            transition: all 0.3s ease;
        }

        .save-param-btn:hover {
            background-color: #229954;
            border-color: #229954;
            transform: translateY(-1px);
        }

        #fuenteDC-container {
            transition: all 0.3s ease;
        }


    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <span id="connection-status-indicator" class="status-indicator disconnected"></span>
                Control de Cargador Solar 
                <small id="firmware-version-display" class="ms-2">vX.X</small>
            </a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3 d-none d-md-inline">√öltima Actualizaci√≥n: <span id="last-update-time">--:--:--</span></span>
                <span class="text-white me-3 d-none d-md-inline">Uptime: <span id="server-uptime-display">0s</span></span>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Alerts/Toasts Placeholder -->
        <div id="alerts-container" class="alert-fixed"></div>

        <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard-tab-pane" type="button" role="tab" aria-controls="dashboard-tab-pane" aria-selected="true">
                    <i class="fas fa-tachometer-alt me-2 fallback-icon dashboard"></i>Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="configuration-tab" data-bs-toggle="tab" data-bs-target="#configuration-tab-pane" type="button" role="tab" aria-controls="configuration-tab-pane" aria-selected="false">
                    <i class="fas fa-cog me-2 fallback-icon config"></i>Configuraci√≥n
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="load-control-tab" data-bs-toggle="tab" data-bs-target="#load-control-tab-pane" type="button" role="tab" aria-controls="load-control-tab-pane" aria-selected="false">
                    <i class="fas fa-lightbulb me-2 fallback-icon load"></i>Control de Carga
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="system-logs-tab" data-bs-toggle="tab" data-bs-target="#system-logs-tab-pane" type="button" role="tab" aria-controls="system-logs-tab-pane" aria-selected="false">
                    <i class="fas fa-info-circle me-2 fallback-icon logs"></i>Sistema & Logs
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tools-tab" data-bs-toggle="tab" data-bs-target="#tools-tab-pane" type="button" role="tab" aria-controls="tools-tab-pane" aria-selected="false">
                    <i class="fas fa-tools me-2 fallback-icon tools"></i>Herramientas
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="night-schedule-tab" data-bs-toggle="tab" data-bs-target="#night-schedule-tab-pane" type="button" role="tab" aria-controls="night-schedule-tab-pane" aria-selected="false">
                    <i class="fas fa-moon me-2 fallback-icon moon"></i>Programaci√≥n Nocturna
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabsContent">
            <!-- Dashboard Tab Pane -->
            <div class="tab-pane fade show active" id="dashboard-tab-pane" role="tabpanel" aria-labelledby="dashboard-tab">
                <div class="row">
                    <!-- Main Metrics -->
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card metric-card h-100 bg-primary-subtle text-primary">
                            <div class="card-body">
                                <div>
                                    <div class="metric-label">Voltaje Bater√≠a</div>
                                    <div class="metric-value"><span id="battery-voltage">0.00</span><span class="metric-unit">V</span></div>
                                </div>
                                <i class="fas fa-car-battery metric-icon text-primary fallback-icon battery"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card metric-card h-100 bg-success-subtle text-success">
                            <div class="card-body">
                                <div>
                                    <div class="metric-label">Voltaje Panel</div>
                                    <div class="metric-value"><span id="panel-voltage">0.00</span><span class="metric-unit">V</span></div>
                                </div>
                                <i class="fas fa-sun metric-icon text-success fallback-icon sun"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card metric-card h-100 bg-info-subtle text-info">
                            <div class="card-body">
                                <div>
                                    <div class="metric-label">Corriente Panel</div>
                                    <div class="metric-value"><span id="panel-current">0.00</span><span class="metric-unit">A</span></div>
                                </div>
                                <i class="fas fa-arrow-down metric-icon text-info">‚¨áÔ∏è</i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card metric-card h-100 bg-danger-subtle text-danger">
                            <div class="card-body">
                                <div>
                                    <div class="metric-label">Corriente Carga</div>
                                    <div class="metric-value"><span id="load-current">0.00</span><span class="metric-unit">A</span></div>
                                </div>
                                <i class="fas fa-arrow-up metric-icon text-danger">‚¨ÜÔ∏è</i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card metric-card h-100 bg-warning-subtle text-warning">
                            <div class="card-body">
                                <div>
                                    <div class="metric-label">Corriente Neta</div>
                                    <div class="metric-value"><span id="net-current">0.00</span><span class="metric-unit">A</span></div>
                                </div>
                                <i class="fas fa-exchange-alt metric-icon text-warning">‚ÜîÔ∏è</i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card metric-card h-100 bg-secondary-subtle text-secondary">
                            <div class="card-body">
                                <div>
                                    <div class="metric-label">Temperatura</div>
                                    <div class="metric-value"><span id="temperature">0.0</span><span class="metric-unit">¬∞C</span></div>
                                </div>
                                <i class="fas fa-thermometer-half metric-icon text-secondary fallback-icon thermometer"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Charge State & SOC -->
                    <div class="col-lg-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header">üîã Estado de Carga</div>
                            <div class="card-body">
                                <p class="card-text"><strong>Estado:</strong> <span id="charge-state" class="badge bg-primary">UNKNOWN</span></p>
                                <p class="card-text"><strong>SOC Estimado:</strong> <span id="estimated-soc">0</span>% <div class="progress mt-2"><div class="progress-bar" role="progressbar" id="soc-progress-bar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div></div></p>
                                <p class="card-text"><strong>Ah Acumulados:</strong> <span id="accumulated-ah">0.00</span> Ah</p>
                                <p class="card-text"><strong>Horas de Absorci√≥n Calculadas:</strong> <span id="calculated-absorption-hours">0.0</span>h</p>
                            </div>
                        </div>
                    </div>
                    <!-- Load Control Status -->
                    <div class="col-lg-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header">‚öôÔ∏è Estado de Control</div>
                            <div class="card-body">
                                <p class="card-text"><strong>Carga Activada:</strong> <span id="load-control-state" class="badge bg-secondary">--</span></p>
                                <p class="card-text"><strong>Carga Temporalmente Apagada:</strong> <span id="temporary-load-off" class="badge bg-secondary">--</span></p>
                                <p class="card-text"><strong>Tiempo Restante (Apagado Temporal):</strong> <span id="load-off-remaining-time">00:00:00</span></p>
                                <p class="card-text"><strong>LED Solar:</strong> <span id="led-solar-state" class="badge bg-secondary">--</span></p>
                                <p class="card-text"><strong>Nota Personalizada:</strong> <span id="custom-note"></span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Charts -->
                    <div class="col-lg-6 mb-3">
                        <div class="card">
                            <div class="card-header">üìà Corriente (A)</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="currentChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <div class="card">
                            <div class="card-header">üìä Voltaje (V)</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="voltageChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            

            <!-- Configuration Tab Pane -->
            <div class="tab-pane fade" id="configuration-tab-pane" role="tabpanel" aria-labelledby="configuration-tab">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">‚öôÔ∏è Par√°metros del Cargador</div>
                            <div class="card-body">
                                <div class="accordion" id="configAccordion">
                                    
                                    <!-- Secci√≥n de Bater√≠a -->
                                    <div class="card config-section">
                                        <div class="card-header" >
                                            <h5>üîã Configuraci√≥n de Bater√≠a</h5>
                                            <span class="toggle-icon">‚ñº</span>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="batteryCapacity" class="form-label">Capacidad de Bater√≠a (Ah):</label>
                                                    <input type="number" step="0.1" min="1" max="1000" class="form-control" id="batteryCapacity" data-param="batteryCapacity">
                                                    <small class="form-text text-muted">Capacidad total del banco de bater√≠as</small>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="thresholdPercentage" class="form-label">Umbral de Corriente (%):</label>
                                                    <input type="number" step="0.1" min="0.1" max="5" class="form-control" id="thresholdPercentage" data-param="thresholdPercentage">
                                                    <small class="form-text text-muted">Porcentaje para calcular el umbral de absorci√≥n</small>
                                                </div>
                                            </div>
                                            <div class="mb-3 form-check form-switch">
                                                <input class="form-check-input" type="checkbox" role="switch" id="isLithium" data-param="isLithium">
                                                <label class="form-check-label" for="isLithium"><strong>Bater√≠a de Litio</strong></label>
                                                <small class="form-text text-muted d-block">Activar para perfiles de carga espec√≠ficos de Litio</small>
                                            </div>
                                            <button class="btn btn-primary btn-sm save-param-btn" data-params="batteryCapacity,thresholdPercentage,isLithium">
                                                üíæ Guardar Configuraci√≥n de Bater√≠a
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Secci√≥n de Voltajes -->
                                    <div class="card config-section">
                                        <div class="card-header" >
                                            <h5>‚ö° Voltajes de Carga</h5>
                                            <span class="toggle-icon">‚ñº</span>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-4 mb-3">
                                                    <label for="bulkVoltage" class="form-label">Voltaje BULK (V):</label>
                                                    <input type="number" step="0.1" min="12.0" max="15.0" class="form-control" id="bulkVoltage" data-param="bulkVoltage">
                                                    <small class="form-text text-muted">Etapa de carga inicial</small>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label for="absorptionVoltage" class="form-label">Voltaje ABSORCI√ìN (V):</label>
                                                    <input type="number" step="0.1" min="12.0" max="15.0" class="form-control" id="absorptionVoltage" data-param="absorptionVoltage">
                                                    <small class="form-text text-muted">Etapa de saturaci√≥n</small>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label for="floatVoltage" class="form-label">Voltaje FLOTACI√ìN (V):</label>
                                                    <input type="number" step="0.1" min="12.0" max="15.0" class="form-control" id="floatVoltage" data-param="floatVoltage">
                                                    <small class="form-text text-muted">Solo para bater√≠as GEL</small>
                                                </div>
                                            </div>
                                            <button class="btn btn-primary btn-sm save-param-btn" data-params="bulkVoltage,absorptionVoltage,floatVoltage">
                                                üíæ Guardar Voltajes de Carga
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Secci√≥n de Corriente -->
                                    <div class="card config-section">
                                        <div class="card-header" >
                                            <h5>üîå L√≠mites de Corriente</h5>
                                            <span class="toggle-icon">‚ñº</span>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="maxAllowedCurrent" class="form-label">Corriente M√°xima Permitida (mA):</label>
                                                <input type="number" step="100" min="1000" max="15000" class="form-control" id="maxAllowedCurrent" data-param="maxAllowedCurrent">
                                                <small class="form-text text-muted">L√≠mite de seguridad para proteger el sistema</small>
                                            </div>
                                            <button class="btn btn-primary btn-sm save-param-btn" data-params="maxAllowedCurrent">
                                                üíæ Guardar L√≠mites de Corriente
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Secci√≥n de Fuente de Energ√≠a -->
                                    <div class="card config-section">
                                        <div class="card-header" >
                                            <h5>üåû Fuente de Energ√≠a</h5>
                                            <span class="toggle-icon">‚ñº</span>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" role="switch" id="useFuenteDC" data-param="useFuenteDC">
                                                        <label class="form-check-label" for="useFuenteDC"><strong>Usar Fuente DC</strong></label>
                                                        <small class="form-text text-muted d-block">Desactivar para usar paneles solares</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 mb-3" id="fuenteDC-container" style="display: none;">
                                                    <label for="fuenteDC_Amps" class="form-label">Amperios Fuente DC:</label>
                                                    <input type="number" step="0.1" min="0" max="50" class="form-control" id="fuenteDC_Amps" data-param="fuenteDC_Amps">
                                                    <small class="form-text text-muted">Capacidad de la fuente DC externa</small>
                                                </div>
                                            </div>
                                            <button class="btn btn-primary btn-sm save-param-btn" data-params="useFuenteDC,fuenteDC_Amps">
                                                üíæ Guardar Configuraci√≥n de Fuente
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Secci√≥n de Informaci√≥n (Solo Lectura) -->
                                    <div class="card config-section">
                                        <div class="card-header" >
                                            <h5>üìä Valores Calculados (Solo Lectura)</h5>
                                            <span class="toggle-icon">‚ñº</span>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-2">
                                                    <strong>Umbral de Corriente Calculado:</strong>
                                                    <span id="display-absorptionCurrentThreshold" class="text-info">-- mA</span>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <strong>L√≠mite en Flotaci√≥n:</strong>
                                                    <span id="display-currentLimitIntoFloatStage" class="text-info">-- mA</span>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <strong>Factor Divisor:</strong>
                                                    <span id="display-factorDivider" class="text-info">--</span>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <strong>Tiempo M√°x. Bulk:</strong>
                                                    <span id="display-maxBulkHours" class="text-info">-- h</span>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <strong>LVD (Desconexi√≥n):</strong>
                                                    <span id="display-LVD" class="text-warning">-- V</span>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <strong>LVR (Reconexi√≥n):</strong>
                                                    <span id="display-LVR" class="text-warning">-- V</span>
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                <em>Estos valores se calculan autom√°ticamente basados en la configuraci√≥n.</em>
                                            </small>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>







            <!-- Load Control Tab Pane -->
            <div class="tab-pane fade" id="load-control-tab-pane" role="tabpanel" aria-labelledby="load-control-tab">
                <div class="row">
                    <!-- Cron√≥metro Visual -->
                    <div class="col-12 mb-3">
                        <div class="card">
                            <div class="card-header">‚è∞ Cron√≥metro de Apagado Temporal</div>
                            <div class="card-body">
                                <div id="countdown-display" class="countdown-container countdown-inactive">
                                    <div class="countdown-label">Tiempo restante para reactivaci√≥n</div>
                                    
                                    <!-- Cron√≥metro circular con SVG -->
                                    <svg class="progress-ring" width="120" height="120">
                                        <circle id="progress-ring-circle" class="progress-ring-circle" 
                                                stroke-dasharray="314" 
                                                stroke-dashoffset="314" 
                                                cx="60" cy="60" r="50">
                                        </circle>
                                    </svg>
                                    
                                    <div id="countdown-timer" class="countdown-timer">00:00:00</div>
                                    <div id="countdown-status" class="countdown-status">Carga Activa</div>
                                    
                                    <div class="countdown-controls">
                                        <button id="visual-cancel-countdown-btn" style="display: none;">
                                            ‚ùå Cancelar Apagado
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Informaci√≥n adicional -->
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <strong>Tiempo total programado:</strong> <span id="total-programmed-time">00:00:00</span><br>
                                            <strong>Tiempo transcurrido:</strong> <span id="elapsed-time">00:00:00</span><br>
                                            <strong>Progreso:</strong> <span id="progress-percentage">0%</span>
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <strong>Programado:</strong> <span id="scheduled-time">--</span><br>
                                            <strong>Finaliza:</strong> <span id="end-time">--</span><br>
                                            <strong>Estado:</strong> <span id="countdown-load-status">Normal</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Controles originales -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header">‚è∞ Apagar Carga Temporalmente</div>
                            <div class="card-body">
                                <p class="card-text">Apaga la salida de carga durante un per√≠odo de tiempo especificado. √ötil para mantenimiento o para forzar el apagado.</p>
                                <div class="row g-3 align-items-end mb-3">
                                    <div class="col-md-4">
                                        <label for="loadOffHours" class="form-label">Horas:</label>
                                        <input type="number" min="0" max="12" class="form-control" id="loadOffHours" value="0">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="loadOffMinutes" class="form-label">Minutos:</label>
                                        <input type="number" min="0" max="59" class="form-control" id="loadOffMinutes" value="0">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="loadOffSeconds" class="form-label">Segundos:</label>
                                        <input type="number" min="0" max="59" class="form-control" id="loadOffSeconds" value="0">
                                    </div>
                                </div>
                                <button class="btn btn-warning" id="toggle-load-btn">‚è∞ Apagar Carga</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header">üîÑ Cancelar Apagado Temporal</div>
                            <div class="card-body">
                                <p class="card-text">Si la carga ha sido apagada temporalmente, puedes reactivarla manualmente con este bot√≥n.</p>
                                <button class="btn btn-success" id="cancel-temp-off-btn">‚úÖ Reactivar Carga</button>
                                <hr>
                                <p class="card-text"><strong>Estado Actual de Carga:</strong> <span id="current-load-status" class="badge bg-secondary">Cargando...</span></p>
                                
                                <!-- Informaci√≥n adicional del sistema -->
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <strong>Tiempo restante del servidor:</strong> <span id="load-off-remaining-time">00:00:00</span><br>
                                        <strong>Apagado temporal activo:</strong> <span id="temporary-load-off" class="badge bg-secondary">--</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- System & Logs Tab Pane -->
            <div class="tab-pane fade" id="system-logs-tab-pane" role="tabpanel" aria-labelledby="system-logs-tab">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header">üñ•Ô∏è Informaci√≥n del Sistema (Orange Pi)</div>
                            <div class="card-body">
                                <p><strong>Hostname:</strong> <span id="sysinfo-hostname">N/A</span></p>
                                <p><strong>Plataforma:</strong> <span id="sysinfo-platform">N/A</span></p>
                                <p><strong>Versi√≥n Python:</strong> <span id="sysinfo-python">N/A</span></p>
                                <p><strong>Uso CPU:</strong> <span id="sysinfo-cpu">N/A</span></p>
                                <p><strong>Uso Memoria:</strong> <span id="sysinfo-memory">N/A</span></p>
                                <p><strong>Uso Disco:</strong> <span id="sysinfo-disk">N/A</span></p>
                                <p><strong>Boot Time:</strong> <span id="sysinfo-boot-time">N/A</span></p>
                                <p><strong>Server Uptime:</strong> <span id="sysinfo-server-uptime">N/A</span></p>
                                <button class="btn btn-info btn-sm" id="refresh-sysinfo-btn">üîÑ Actualizar Info Sistema</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header">üìã Logs del Servidor</div>
                            <div class="card-body d-flex flex-column h-100">
                                <div class="mb-2 d-flex align-items-center">
                                    <label for="logLines" class="form-label me-2 mb-0">L√≠neas:</label>
                                    <input type="number" class="form-control form-control-sm me-2" id="logLines" value="100" min="10" max="1000" style="width: 80px;">
                                    <button class="btn btn-dark btn-sm" id="refresh-logs-btn">üîÑ Actualizar Logs</button>
                                </div>
                                <pre id="log-content" class="log-display flex-grow-1">Cargando logs...</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tools Tab Pane -->
            <div class="tab-pane fade" id="tools-tab-pane" role="tabpanel" aria-labelledby="tools-tab">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header">üì• Exportar Configuraci√≥n</div>
                            <div class="card-body">
                                <p class="card-text">Descarga la configuraci√≥n actual del cargador como un archivo JSON.</p>
                                <button class="btn btn-primary" id="export-config-btn">üì• Exportar Configuraci√≥n</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header">üì§ Importar Configuraci√≥n</div>
                            <div class="card-body">
                                <p class="card-text">Sube un archivo JSON para importar la configuraci√≥n del cargador.</p>
                                <input type="file" class="form-control mb-3" id="import-config-file" accept=".json">
                                <button class="btn btn-secondary" id="import-config-btn">üì§ Importar Configuraci√≥n</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Night Schedule Tab Pane - AGREGAR ANTES DEL CIERRE DE tab-content -->
            <div class="tab-pane fade" id="night-schedule-tab-pane" role="tabpanel" aria-labelledby="night-schedule-tab">
                <div class="row">
                    <!-- Scheduler Principal -->
                    <div class="col-12 mb-3">
                        <div class="card">
                            <div class="card-header">üåô Programaci√≥n Autom√°tica Nocturna</div>
                            <div class="card-body">
                                <div id="night-scheduler" class="night-scheduler night-waiting">
                                    <h3 style="margin-top: 0;">Apagado Autom√°tico Nocturno</h3>
                                    
                                    <div class="night-timer" id="night-countdown">
                                        Calculando...
                                    </div>
                                    
                                    <div class="night-status" id="night-status">
                                        Esperando medianoche...
                                    </div>

                                    <div class="schedule-info">
                                        <div class="schedule-item">
                                            <h4>üïõ Inicio de Apagado</h4>
                                            <div class="time" id="display-start-time">00:00</div>
                                            <small>Medianoche</small>
                                        </div>
                                        <div class="schedule-item">
                                            <h4>‚è∞ Duraci√≥n</h4>
                                            <div class="time" id="display-duration">6:00h</div>
                                            <small>Horas de apagado</small>
                                        </div>
                                        <div class="schedule-item">
                                            <h4>üåÖ Reactivaci√≥n</h4>
                                            <div class="time" id="display-end-time">06:00</div>
                                            <small>Amanecer</small>
                                        </div>
                                    </div>

                                    <div class="night-controls">
                                        <button class="btn btn-warning" id="override-night-btn" style="display: none;">
                                            üîì Activar Carga (Override)
                                        </button>
                                        <button class="btn btn-danger" id="skip-night-btn">
                                            ‚è≠Ô∏è Saltar Esta Noche
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuraci√≥n -->
                    <div class="col-md-8 mb-3">
                        <div class="card h-100">
                            <div class="card-header">‚öôÔ∏è Configuraci√≥n de Programaci√≥n Nocturna</div>
                            <div class="card-body">
                                <div style="display: flex; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                                    <label style="font-weight: bold;">
                                        Programaci√≥n autom√°tica nocturna:
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="night-schedule-enabled" checked>
                                        <span class="slider"></span>
                                    </label>
                                    <span id="schedule-status-text">Activado</span>
                                </div>

                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                    <div>
                                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">
                                            üïõ Hora de inicio:
                                        </label>
                                        <input type="time" id="night-start-time" value="00:00" class="form-control">
                                    </div>
                                    <div>
                                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">
                                            üåÖ Hora de fin:
                                        </label>
                                        <input type="time" id="night-end-time" value="06:00" class="form-control">
                                    </div>
                                    <div>
                                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">
                                            üìÖ D√≠as activos:
                                        </label>
                                        <select id="active-days" class="form-control">
                                            <option value="daily">Todos los d√≠as</option>
                                            <option value="weekdays">Solo lunes a viernes</option>
                                            <option value="weekends">Solo fines de semana</option>
                                            <option value="custom">Personalizado</option>
                                        </select>
                                    </div>
                                </div>

                                <div id="custom-days" style="display: none; margin-bottom: 20px;">
                                    <label style="font-weight: bold; display: block; margin-bottom: 10px;">
                                        Seleccionar d√≠as espec√≠ficos:
                                    </label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                        <label><input type="checkbox" id="day-0" checked> Domingo</label>
                                        <label><input type="checkbox" id="day-1" checked> Lunes</label>
                                        <label><input type="checkbox" id="day-2" checked> Martes</label>
                                        <label><input type="checkbox" id="day-3" checked> Mi√©rcoles</label>
                                        <label><input type="checkbox" id="day-4" checked> Jueves</label>
                                        <label><input type="checkbox" id="day-5" checked> Viernes</label>
                                        <label><input type="checkbox" id="day-6" checked> S√°bado</label>
                                    </div>
                                </div>

                                <div>
                                    <button class="btn btn-primary" id="save-schedule-btn">
                                        üíæ Guardar Configuraci√≥n
                                    </button>
                                    <button class="btn btn-warning" id="test-schedule-btn">
                                        üß™ Probar Ahora (30 seg)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estado del Sistema -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-header">üìä Estado del Sistema</div>
                            <div class="card-body">
                                <div style="margin-bottom: 15px;">
                                    <strong>Pr√≥ximo apagado:</strong><br>
                                    <span id="next-shutdown" style="font-family: monospace; font-size: 0.9em;">--:--:--</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <strong>Pr√≥xima reactivaci√≥n:</strong><br>
                                    <span id="next-activation" style="font-family: monospace; font-size: 0.9em;">--:--:--</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <strong>Estado actual:</strong><br>
                                    <span id="current-system-status" class="badge bg-success">Normal</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <strong>√öltima ejecuci√≥n:</strong><br>
                                    <span id="last-execution" style="font-family: monospace; font-size: 0.9em;">Nunca</span>
                                </div>

                                <div style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                    <strong style="font-size: 0.9em;">üìù √öltimos eventos:</strong>
                                    <div id="event-log" style="margin-top: 10px; max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.7em;">
                                        <div>Sistema iniciado</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <footer class="footer">
        <p>¬© 2024 Orange Pi Solar Charger Control. Hecho con ‚ù§Ô∏è para tu proyecto.</p>
    </footer>

    <!-- Bootstrap 5 JS desde CDN m√°s estable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const API_BASE_URL = '/api';
        const UPDATE_INTERVAL_MS = 2000; // 2 segundos

        let currentData = {};
        let currentChart, voltageChart;
        const chartDataPoints = 60; // Keep 60 data points (2 minutes at 2s interval)
        const chartLabels = [];
        const panelCurrentData = [];
        const batteryCurrentData = [];
        const batteryVoltageData = [];
        const panelVoltageData = [];

        // --- Utility Functions ---
        
        
        // ===== AGREGAR DESPU√âS DE LAS VARIABLES GLOBALES EXISTENTES =====

        // Clase para manejar el cron√≥metro visual
        class CountdownManager {
            constructor() {
                this.countdownInterval = null;
                this.totalDurationSeconds = 0;
                this.remainingSeconds = 0;
                this.startTime = null;
                this.scheduledEndTime = null;
            }

            // Funci√≥n para formatear tiempo
            formatTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }

            // Funci√≥n para actualizar el cron√≥metro visual
            updateCountdownDisplay() {
                const timerElement = document.getElementById('countdown-timer');
                const statusElement = document.getElementById('countdown-status');
                const containerElement = document.getElementById('countdown-display');
                const cancelBtn = document.getElementById('visual-cancel-countdown-btn');
                const progressRing = document.getElementById('progress-ring-circle');
                
                if (!timerElement) return; // Salir si no existe el elemento
                
                // Actualizar tiempo restante
                timerElement.textContent = this.formatTime(this.remainingSeconds);
                
                // Actualizar informaci√≥n adicional
                const totalProgrammedEl = document.getElementById('total-programmed-time');
                const elapsedTimeEl = document.getElementById('elapsed-time');
                const progressPercentageEl = document.getElementById('progress-percentage');
                const scheduledTimeEl = document.getElementById('scheduled-time');
                const endTimeEl = document.getElementById('end-time');
                const countdownLoadStatusEl = document.getElementById('countdown-load-status');
                
                if (totalProgrammedEl) totalProgrammedEl.textContent = this.formatTime(this.totalDurationSeconds);
                if (elapsedTimeEl) elapsedTimeEl.textContent = this.formatTime(this.totalDurationSeconds - this.remainingSeconds);
                
                const progress = this.totalDurationSeconds > 0 ? ((this.totalDurationSeconds - this.remainingSeconds) / this.totalDurationSeconds) * 100 : 0;
                if (progressPercentageEl) progressPercentageEl.textContent = `${Math.round(progress)}%`;
                
                // Actualizar anillo de progreso
                if (progressRing) {
                    const circumference = 2 * Math.PI * 50; // radio = 50
                    const offset = circumference - (progress / 100) * circumference;
                    progressRing.style.strokeDashoffset = offset;
                }
                
                // Actualizar horarios
                if (this.startTime && scheduledTimeEl) {
                    scheduledTimeEl.textContent = new Date(this.startTime).toLocaleTimeString();
                }
                if (this.scheduledEndTime && endTimeEl) {
                    endTimeEl.textContent = new Date(this.scheduledEndTime).toLocaleTimeString();
                }
                
                // Actualizar estados visuales
                if (this.remainingSeconds <= 0) {
                    // Carga activa
                    if (statusElement) statusElement.textContent = '‚úÖ Carga Activa';
                    if (containerElement) containerElement.className = 'countdown-container countdown-inactive';
                    if (cancelBtn) cancelBtn.style.display = 'none';
                    if (countdownLoadStatusEl) countdownLoadStatusEl.textContent = 'Normal';
                    
                    if (this.countdownInterval) {
                        clearInterval(this.countdownInterval);
                        this.countdownInterval = null;
                    }
                } else if (this.remainingSeconds <= 60) {
                    // Estado cr√≠tico (√∫ltimo minuto)
                    if (statusElement) statusElement.textContent = 'üö® ¬°√öltimos segundos!';
                    if (containerElement) containerElement.className = 'countdown-container countdown-critical';
                    if (cancelBtn) cancelBtn.style.display = 'inline-block';
                    if (countdownLoadStatusEl) countdownLoadStatusEl.textContent = 'Cr√≠tico';
                } else if (this.remainingSeconds <= 300) {
                    // Estado de advertencia (√∫ltimos 5 minutos)
                    if (statusElement) statusElement.textContent = '‚ö†Ô∏è Carga Temporalmente Apagada';
                    if (containerElement) containerElement.className = 'countdown-container countdown-warning';
                    if (cancelBtn) cancelBtn.style.display = 'inline-block';
                    if (countdownLoadStatusEl) countdownLoadStatusEl.textContent = 'Advertencia';
                } else {
                    // Estado normal
                    if (statusElement) statusElement.textContent = '‚è∏Ô∏è Carga Temporalmente Apagada';
                    if (containerElement) containerElement.className = 'countdown-container countdown-normal';
                    if (cancelBtn) cancelBtn.style.display = 'inline-block';
                    if (countdownLoadStatusEl) countdownLoadStatusEl.textContent = 'Apagado Temporal';
                }
            }

            // Sincronizar con datos del servidor
            syncWithServerData(serverData) {
                if (serverData.temporaryLoadOff && serverData.loadOffRemainingSeconds > 0) {
                    // Hay apagado temporal activo
                    this.remainingSeconds = serverData.loadOffRemainingSeconds;
                    this.totalDurationSeconds = serverData.loadOffDuration || this.totalDurationSeconds;
                    
                    // Calcular tiempos si no est√°n establecidos
                    if (!this.startTime) {
                        this.startTime = Date.now() - ((this.totalDurationSeconds - this.remainingSeconds) * 1000);
                    }
                    if (!this.scheduledEndTime) {
                        this.scheduledEndTime = Date.now() + (this.remainingSeconds * 1000);
                    }
                    
                    // Iniciar countdown si no est√° activo
                    if (!this.countdownInterval) {
                        this.startCountdownTimer();
                    }
                } else {
                    // No hay apagado temporal activo
                    this.stopCountdown();
                }
                
                this.updateCountdownDisplay();
            }

            // Iniciar el timer interno
            startCountdownTimer() {
                if (this.countdownInterval) {
                    clearInterval(this.countdownInterval);
                }
                
                this.countdownInterval = setInterval(() => {
                    this.remainingSeconds--;
                    this.updateCountdownDisplay();
                    
                    if (this.remainingSeconds <= 0) {
                        this.stopCountdown();
                        
                        // Notificaci√≥n de reactivaci√≥n
                        if ('Notification' in window && Notification.permission === 'granted') {
                            new Notification('üîã Carga Reactivada', {
                                body: 'El apagado temporal ha finalizado. La carga se ha reactivado autom√°ticamente.',
                                icon: '/favicon.ico'
                            });
                        }
                        
                        console.log('üîã Carga reactivada autom√°ticamente');
                    }
                }, 1000);
            }

            // Detener countdown
            stopCountdown() {
                if (this.countdownInterval) {
                    clearInterval(this.countdownInterval);
                    this.countdownInterval = null;
                }
                
                this.remainingSeconds = 0;
                this.totalDurationSeconds = 0;
                this.startTime = null;
                this.scheduledEndTime = null;
                this.updateCountdownDisplay();
            }

            // Guardar estado en localStorage
            saveState() {
                if (this.remainingSeconds > 0) {
                    localStorage.setItem('countdownState', JSON.stringify({
                        remainingSeconds: this.remainingSeconds,
                        totalDurationSeconds: this.totalDurationSeconds,
                        startTime: this.startTime,
                        scheduledEndTime: this.scheduledEndTime,
                        lastUpdate: Date.now()
                    }));
                } else {
                    localStorage.removeItem('countdownState');
                }
            }

            // Restaurar estado desde localStorage
            restoreState() {
                const savedState = localStorage.getItem('countdownState');
                if (savedState) {
                    try {
                        const state = JSON.parse(savedState);
                        const now = Date.now();
                        const elapsedSeconds = Math.floor((now - state.lastUpdate) / 1000);
                        
                        this.remainingSeconds = Math.max(0, state.remainingSeconds - elapsedSeconds);
                        this.totalDurationSeconds = state.totalDurationSeconds;
                        this.startTime = state.startTime;
                        this.scheduledEndTime = state.scheduledEndTime;
                        
                        if (this.remainingSeconds > 0) {
                            this.startCountdownTimer();
                        } else {
                            localStorage.removeItem('countdownState');
                        }
                        
                        this.updateCountdownDisplay();
                    } catch (e) {
                        console.error('Error restaurando estado del countdown:', e);
                        localStorage.removeItem('countdownState');
                    }
                }
            }
        }


        // ===== AGREGAR DESPU√âS DE LA CLASE COUNTDOWNMANAGER =====

        class NightScheduler {
            constructor() {
                this.enabled = true;
                this.startTime = '00:00';
                this.endTime = '06:00';
                this.activeDays = 'daily';
                this.isActive = false;
                this.nextShutdown = null;
                this.nextActivation = null;
                this.checkInterval = null;
                this.countdownInterval = null;
                this.skippedTonight = false;
                this.lastExecution = null;
                
                this.loadConfiguration();
            }

            loadConfiguration() {
                const saved = localStorage.getItem('nightScheduleConfig');
                if (saved) {
                    try {
                        const config = JSON.parse(saved);
                        this.enabled = config.enabled !== false;
                        this.startTime = config.startTime || '00:00';
                        this.endTime = config.endTime || '06:00';
                        this.activeDays = config.activeDays || 'daily';
                        this.lastExecution = config.lastExecution || null;
                    } catch (e) {
                        console.error('Error loading night schedule:', e);
                    }
                }
            }

            saveConfiguration() {
                const config = {
                    enabled: this.enabled,
                    startTime: this.startTime,
                    endTime: this.endTime,
                    activeDays: this.activeDays,
                    lastExecution: this.lastExecution
                };
                localStorage.setItem('nightScheduleConfig', JSON.stringify(config));
                this.logEvent('Configuraci√≥n guardada');
            }

            calculateNextEvents() {
                if (!this.enabled) {
                    this.nextShutdown = null;
                    this.nextActivation = null;
                    return;
                }

                const now = new Date();
                const [startHour, startMin] = this.startTime.split(':').map(Number);
                const [endHour, endMin] = this.endTime.split(':').map(Number);

                // Calcular pr√≥ximo apagado
                let nextShutdown = new Date();
                nextShutdown.setHours(startHour, startMin, 0, 0);
                
                // Si ya pas√≥ la hora de hoy, ir al d√≠a siguiente
                if (nextShutdown <= now) {
                    nextShutdown.setDate(nextShutdown.getDate() + 1);
                    nextShutdown.setHours(startHour, startMin, 0, 0);
                }

                // Calcular pr√≥xima reactivaci√≥n
                let nextActivation = new Date(nextShutdown);
                nextActivation.setHours(endHour, endMin, 0, 0);
                
                // Si el fin es al d√≠a siguiente (ej: 00:00 - 06:00)
                if (endHour < startHour || (endHour === startHour && endMin < startMin)) {
                    nextActivation.setDate(nextActivation.getDate() + 1);
                }

                this.nextShutdown = nextShutdown;
                this.nextActivation = nextActivation;
            }

            startScheduler() {
                this.calculateNextEvents();
                
                // Verificar cada minuto
                this.checkInterval = setInterval(() => {
                    this.checkSchedule();
                    this.updateUI();
                }, 60000);

                // Actualizar countdown cada segundo
                this.countdownInterval = setInterval(() => {
                    this.updateCountdown();
                }, 1000);

                this.logEvent('Programaci√≥n nocturna iniciada');
            }

            checkSchedule() {
                if (!this.enabled || this.skippedTonight) return;

                const now = new Date();
                
                // Verificar si debe iniciar apagado
                if (this.nextShutdown && now >= this.nextShutdown && !this.isActive) {
                    this.executeShutdown();
                }
                
                // Verificar si debe reactivar
                if (this.nextActivation && now >= this.nextActivation && this.isActive) {
                    this.executeActivation();
                }

                // Recalcular eventos si es necesario
                if (now > this.nextActivation) {
                    this.calculateNextEvents();
                    this.skippedTonight = false;
                }
            }

            async executeShutdown() {
                this.isActive = true;
                this.lastExecution = new Date().toISOString();
                this.logEvent(`üåô Iniciando apagado nocturno autom√°tico`);
                
                try {
                    const durationSeconds = this.getDurationInSeconds();
                    const hours = Math.floor(durationSeconds / 3600);
                    const minutes = Math.floor((durationSeconds % 3600) / 60);
                    const seconds = durationSeconds % 60;
                    
                    await toggleLoad(hours, minutes, seconds);
                    console.log('üåô Apagado nocturno ejecutado correctamente');
                } catch (error) {
                    console.error('Error ejecutando apagado nocturno:', error);
                }
                
                this.updateSchedulerDisplay();
                
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('üåô Apagado Nocturno Iniciado', {
                        body: `Carga apagada hasta las ${this.endTime}`,
                        icon: '/favicon.ico'
                    });
                }
            }

            async executeActivation() {
                this.isActive = false;
                this.logEvent(`üåÖ Reactivando carga autom√°ticamente`);
                
                try {
                    await cancelTempOff();
                    console.log('üåÖ Reactivaci√≥n autom√°tica ejecutada');
                } catch (error) {
                    console.error('Error ejecutando reactivaci√≥n:', error);
                }
                
                this.calculateNextEvents();
                this.updateSchedulerDisplay();
                
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('üåÖ Carga Reactivada', {
                        body: 'El apagado nocturno ha terminado',
                        icon: '/favicon.ico'
                    });
                }
            }

            getDurationInSeconds() {
                const [startHour, startMin] = this.startTime.split(':').map(Number);
                const [endHour, endMin] = this.endTime.split(':').map(Number);
                
                let duration = (endHour * 60 + endMin) - (startHour * 60 + startMin);
                if (duration <= 0) duration += 24 * 60;
                
                return duration * 60;
            }

            updateCountdown() {
                const countdownEl = document.getElementById('night-countdown');
                if (!countdownEl) return;

                const now = new Date();
                let targetTime = this.isActive ? this.nextActivation : this.nextShutdown;

                if (targetTime) {
                    const diff = targetTime - now;
                    if (diff > 0) {
                        const hours = Math.floor(diff / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                        countdownEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    } else {
                        countdownEl.textContent = '00:00:00';
                    }
                } else {
                    countdownEl.textContent = 'Desactivado';
                }
            }

            updateSchedulerDisplay() {
                const scheduler = document.getElementById('night-scheduler');
                const status = document.getElementById('night-status');
                const overrideBtn = document.getElementById('override-night-btn');

                if (!scheduler || !status) return;

                if (!this.enabled) {
                    scheduler.className = 'night-scheduler night-disabled';
                    status.textContent = '‚ùå Programaci√≥n desactivada';
                    if (overrideBtn) overrideBtn.style.display = 'none';
                } else if (this.isActive) {
                    scheduler.className = 'night-scheduler night-active';
                    status.textContent = 'üåô Apagado nocturno activo';
                    if (overrideBtn) overrideBtn.style.display = 'inline-block';
                } else if (this.skippedTonight) {
                    scheduler.className = 'night-scheduler night-disabled';
                    status.textContent = '‚è≠Ô∏è Saltado para esta noche';
                    if (overrideBtn) overrideBtn.style.display = 'none';
                } else {
                    scheduler.className = 'night-scheduler night-waiting';
                    status.textContent = '‚è∞ Esperando hora programada';
                    if (overrideBtn) overrideBtn.style.display = 'none';
                }

                // Actualizar horarios mostrados
                const displayStartTime = document.getElementById('display-start-time');
                const displayEndTime = document.getElementById('display-end-time');
                const displayDuration = document.getElementById('display-duration');

                if (displayStartTime) displayStartTime.textContent = this.startTime;
                if (displayEndTime) displayEndTime.textContent = this.endTime;
                if (displayDuration) {
                    const duration = this.getDurationInSeconds() / 3600;
                    displayDuration.textContent = `${duration.toFixed(1)}h`;
                }
            }

            updateUI() {
                // Actualizar pr√≥ximos eventos
                const nextShutdownEl = document.getElementById('next-shutdown');
                const nextActivationEl = document.getElementById('next-activation');

                if (nextShutdownEl) {
                    nextShutdownEl.textContent = this.nextShutdown ? 
                        this.nextShutdown.toLocaleString() : 'No programado';
                }

                if (nextActivationEl) {
                    nextActivationEl.textContent = this.nextActivation ? 
                        this.nextActivation.toLocaleString() : 'No programado';
                }

                // Actualizar estado del sistema
                const statusEl = document.getElementById('current-system-status');
                if (statusEl) {
                    if (this.isActive) {
                        statusEl.textContent = 'Apagado Nocturno';
                        statusEl.className = 'badge bg-warning';
                    } else if (!this.enabled) {
                        statusEl.textContent = 'Desactivado';
                        statusEl.className = 'badge bg-secondary';
                    } else {
                        statusEl.textContent = 'Normal';
                        statusEl.className = 'badge bg-success';
                    }
                }

                // Actualizar √∫ltima ejecuci√≥n
                const lastExecutionEl = document.getElementById('last-execution');
                if (lastExecutionEl) {
                    lastExecutionEl.textContent = this.lastExecution ? 
                        new Date(this.lastExecution).toLocaleString() : 'Nunca';
                }

                this.updateSchedulerDisplay();
            }

            initializeUI() {
                // Configurar toggle principal
                const enabledToggle = document.getElementById('night-schedule-enabled');
                if (enabledToggle) {
                    enabledToggle.checked = this.enabled;
                    enabledToggle.addEventListener('change', (e) => {
                        this.enabled = e.target.checked;
                        const statusText = document.getElementById('schedule-status-text');
                        if (statusText) {
                            statusText.textContent = this.enabled ? 'Activado' : 'Desactivado';
                        }
                        this.updateSchedulerDisplay();
                    });
                }

                // Configurar horarios
                const startTimeInput = document.getElementById('night-start-time');
                const endTimeInput = document.getElementById('night-end-time');
                if (startTimeInput) startTimeInput.value = this.startTime;
                if (endTimeInput) endTimeInput.value = this.endTime;

                // Event listeners para botones
                const saveBtn = document.getElementById('save-schedule-btn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        this.updateConfigFromUI();
                        this.saveConfiguration();
                        this.calculateNextEvents();
                        this.updateUI();
                        showToast('‚úÖ Configuraci√≥n de programaci√≥n nocturna guardada', 'success');
                    });
                }

                const testBtn = document.getElementById('test-schedule-btn');
                if (testBtn) {
                    testBtn.addEventListener('click', () => {
                        this.testSchedule();
                    });
                }

                const skipBtn = document.getElementById('skip-night-btn');
                if (skipBtn) {
                    skipBtn.addEventListener('click', () => {
                        this.skipTonight();
                    });
                }

                const overrideBtn = document.getElementById('override-night-btn');
                if (overrideBtn) {
                    overrideBtn.addEventListener('click', () => {
                        this.overrideNightShutdown();
                    });
                }
            }

            updateConfigFromUI() {
                const enabledToggle = document.getElementById('night-schedule-enabled');
                const startTimeInput = document.getElementById('night-start-time');
                const endTimeInput = document.getElementById('night-end-time');

                if (enabledToggle) this.enabled = enabledToggle.checked;
                if (startTimeInput) this.startTime = startTimeInput.value;
                if (endTimeInput) this.endTime = endTimeInput.value;
            }

            skipTonight() {
                this.skippedTonight = true;
                this.logEvent('‚è≠Ô∏è Apagado nocturno saltado para esta noche');
                this.updateSchedulerDisplay();
                showToast('‚úÖ Apagado nocturno saltado para esta noche', 'info');
            }

            async overrideNightShutdown() {
                if (this.isActive) {
                    this.isActive = false;
                    this.logEvent('üîì Override: Carga reactivada manualmente');
                    
                    try {
                        await cancelTempOff();
                        console.log('üîì Override ejecutado correctamente');
                    } catch (error) {
                        console.error('Error en override:', error);
                    }
                    
                    this.updateSchedulerDisplay();
                }
            }

            async testSchedule() {
                if (confirm('¬øProbar el apagado nocturno por 30 segundos?')) {
                    this.logEvent('üß™ Prueba de apagado nocturno (30 segundos)');
                    
                    try {
                        await toggleLoad(0, 0, 30);
                        showToast('üß™ Prueba iniciada - 30 segundos de apagado', 'info');
                    } catch (error) {
                        console.error('Error en prueba:', error);
                        showToast('‚ùå Error en la prueba', 'danger');
                    }
                }
            }

            logEvent(message) {
                const log = document.getElementById('event-log');
                if (log) {
                    const timestamp = new Date().toLocaleTimeString();
                    const entry = document.createElement('div');
                    entry.textContent = `[${timestamp}] ${message}`;
                    log.appendChild(entry);
                    log.scrollTop = log.scrollHeight;
                    
                    // Mantener solo √∫ltimas 20 entradas
                    while (log.children.length > 20) {
                        log.removeChild(log.firstChild);
                    }
                }
                
                console.log(`[NightScheduler] ${message}`);
            }
        }

        // Crear instancia global del night scheduler
        const nightScheduler = new NightScheduler();

        // ===== FIN DE LA CLASE NIGHTSCHEDULER =====



        // Crear instancia global del countdown manager
        const countdownManager = new CountdownManager();

        // ===== FIN DE LA CLASE COUNTDOWNMANAGER =====
        // Mostrar notificaci√≥n de alerta    
        
        

        function showToast(message, type = 'success') {
            const alertsContainer = document.getElementById('alerts-container');
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            const alertElement = document.createElement('div');
            alertElement.innerHTML = alertHtml;
            alertsContainer.appendChild(alertElement);

            // Auto-hide after 5 seconds
            setTimeout(() => {
                try {
                    const alert = alertElement.querySelector('.alert');
                    if (alert) {
                        alert.style.opacity = '0';
                        setTimeout(() => alertElement.remove(), 300);
                    }
                } catch (e) {
                    console.log('Error removing alert:', e);
                }
            }, 5000);
        }

        function formatSecondsToHMS(totalSeconds) {
            if (totalSeconds < 0) totalSeconds = 0;
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function formatUptime(totalSeconds) {
            if (totalSeconds < 60) return `${Math.round(totalSeconds)}s`;
            if (totalSeconds < 3600) return `${Math.round(totalSeconds / 60)}m`;
            if (totalSeconds < 86400) return `${Math.round(totalSeconds / 3600)}h`;
            return `${Math.round(totalSeconds / 86400)}d`;
        }

        // --- UI Update Functions ---
        function updateDashboardUI() {
            document.getElementById('battery-voltage').textContent = (currentData.voltageBatterySensor2 || 0).toFixed(2);
            document.getElementById('panel-voltage').textContent = (currentData.voltagePanel || 0).toFixed(2);
            document.getElementById('panel-current').textContent = ((currentData.panelToBatteryCurrent || 0) / 1000).toFixed(2);
            document.getElementById('load-current').textContent = ((currentData.batteryToLoadCurrent || 0) / 1000).toFixed(2);
            document.getElementById('net-current').textContent = ((currentData.netCurrent || 0) / 1000).toFixed(2);
            document.getElementById('temperature').textContent = (currentData.temperature || 0).toFixed(1);

            document.getElementById('charge-state').textContent = currentData.chargeState || 'UNKNOWN';
            document.getElementById('charge-state').className = `badge bg-${getChargeStateColor(currentData.chargeState)}`;
            
            let soc = Math.max(0, Math.min(100, Math.round(currentData.estimatedSOC || 0)));
            document.getElementById('estimated-soc').textContent = soc;
            const socProgressBar = document.getElementById('soc-progress-bar');
            socProgressBar.style.width = `${soc}%`;
            socProgressBar.setAttribute('aria-valuenow', soc);
            socProgressBar.className = `progress-bar bg-${getSocColor(soc)}`;

            document.getElementById('accumulated-ah').textContent = (currentData.accumulatedAh || 0).toFixed(2);
            document.getElementById('calculated-absorption-hours').textContent = (currentData.calculatedAbsorptionHours || 0).toFixed(1);

            document.getElementById('load-control-state').textContent = currentData.loadControlState ? 'Activa' : 'Inactiva';
            document.getElementById('load-control-state').className = `badge bg-${currentData.loadControlState ? 'success' : 'danger'}`;
            
            document.getElementById('temporary-load-off').textContent = currentData.temporaryLoadOff ? 'S√ç' : 'NO';
            document.getElementById('temporary-load-off').className = `badge bg-${currentData.temporaryLoadOff ? 'warning' : 'secondary'}`;
            
            document.getElementById('load-off-remaining-time').textContent = formatSecondsToHMS(currentData.loadOffRemainingSeconds || 0);

            document.getElementById('led-solar-state').textContent = currentData.ledSolarState ? 'Encendido' : 'Apagado';
            document.getElementById('led-solar-state').className = `badge bg-${currentData.ledSolarState ? 'success' : 'secondary'}`;

            document.getElementById('custom-note').textContent = currentData.notaPersonalizada || 'N/A';
            document.getElementById('firmware-version-display').textContent = `v${currentData.firmware_version || 'Unknown'}`;

            // Update connection status in navbar
            const statusIndicator = document.getElementById('connection-status-indicator');
            if (currentData.connected && (currentData.seconds_since_update || 0) < 5) {
                statusIndicator.className = 'status-indicator connected';
            } else if (currentData.connected && (currentData.seconds_since_update || 0) >= 5) {
                statusIndicator.className = 'status-indicator warning';
            } else {
                statusIndicator.className = 'status-indicator disconnected';
            }
            
            const lastUpdateTime = currentData.last_update ? new Date(currentData.last_update).toLocaleTimeString() : 'N/A';
            document.getElementById('last-update-time').textContent = lastUpdateTime;
            document.getElementById('server-uptime-display').textContent = formatUptime(currentData.server_uptime || 0);
            countdownManager.syncWithServerData(currentData);
        }

        function getChargeStateColor(state) {
            switch (state) {
                case 'BULK_CHARGE': return 'info';
                case 'ABSORPTION_CHARGE': return 'primary';
                case 'FLOAT_CHARGE': return 'success';
                case 'EQUALIZATION': return 'warning';
                case 'IDLE': return 'secondary';
                case 'OVER_VOLTAGE':
                case 'LOW_VOLTAGE_DISCONNECT':
                case 'OVER_TEMPERATURE':
                case 'ERROR':
                    return 'danger';
                default: return 'dark';
            }
        }

        function getSocColor(soc) {
            if (soc <= 20) return 'danger';
            if (soc <= 50) return 'warning';
            return 'success';
        }



        function updateConfigUI() {
            console.log('üîÑ Actualizando interfaz de configuraci√≥n con datos:', currentData);
            
            // Lista de par√°metros a actualizar con sus elementos correspondientes
            const parameterMappings = {
                'batteryCapacity': 'batteryCapacity',
                'thresholdPercentage': 'thresholdPercentage', 
                'maxAllowedCurrent': 'maxAllowedCurrent',
                'bulkVoltage': 'bulkVoltage',
                'absorptionVoltage': 'absorptionVoltage',
                'floatVoltage': 'floatVoltage',
                'isLithium': 'isLithium',
                'useFuenteDC': 'useFuenteDC',
                'fuenteDC_Amps': 'fuenteDC_Amps'
            };
            
            // Actualizar cada par√°metro
            Object.entries(parameterMappings).forEach(([dataKey, elementId]) => {
                const element = document.getElementById(elementId);
                
                if (element && currentData.hasOwnProperty(dataKey)) {
                    const value = currentData[dataKey];
                    
                    if (element.type === 'checkbox') {
                        // Para checkboxes
                        const newChecked = Boolean(value);
                        if (element.checked !== newChecked) {
                            element.checked = newChecked;
                            console.log(`‚úÖ ${dataKey}: ${element.checked}`);
                        }
                    } else if (element.tagName === 'SELECT') {
                        // Para selects (como isLithium)
                        const newValue = String(value);
                        if (element.value !== newValue) {
                            element.value = newValue;
                            console.log(`‚úÖ ${dataKey}: ${element.value}`);
                        }
                    } else {
                        // Para inputs de texto/n√∫mero
                        const newValue = String(value);
                        if (element.value !== newValue) {
                            element.value = newValue;
                            console.log(`‚úÖ ${dataKey}: ${element.value}`);
                        }
                    }
                } else {
                    console.warn(`‚ö†Ô∏è Elemento no encontrado o datos faltantes: ${elementId}`, {
                        elementExists: !!element,
                        dataExists: currentData.hasOwnProperty(dataKey),
                        dataValue: currentData[dataKey]
                    });
                }
            });
            
            // Actualizar campos calculados (solo lectura)
            updateCalculatedValues();
            
            // Actualizar visibilidad del contenedor de fuente DC
            const useFuenteDC = currentData.useFuenteDC;
            const container = document.getElementById('fuenteDC-container');
            if (container) {
                container.style.display = useFuenteDC ? 'block' : 'none';
                console.log(`‚úÖ Contenedor DC: ${useFuenteDC ? 'visible' : 'oculto'}`);
            }
        }



        function updateLoadControlUI() {
            const currentLoadStatus = document.getElementById('current-load-status');
            if (currentLoadStatus) {
                currentLoadStatus.textContent = currentData.loadControlState ? 'Carga Activa' : 'Carga Inactiva';
                currentLoadStatus.className = `badge bg-${currentData.loadControlState ? 'success' : 'danger'}`;
            }
            countdownManager.syncWithServerData(currentData);
        }

        function updateSystemInfoUI(sysInfo) {
            const updateElement = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value || 'N/A';
            };

            updateElement('sysinfo-hostname', sysInfo.hostname);
            updateElement('sysinfo-platform', sysInfo.platform);
            updateElement('sysinfo-python', sysInfo.python_version);
            updateElement('sysinfo-cpu', sysInfo.cpu_percent ? `${sysInfo.cpu_percent.toFixed(1)}%` : null);
            updateElement('sysinfo-memory', sysInfo.memory_percent ? `${sysInfo.memory_percent.toFixed(1)}%` : null);
            updateElement('sysinfo-disk', sysInfo.disk_percent ? `${sysInfo.disk_percent.toFixed(1)}%` : null);
            updateElement('sysinfo-boot-time', sysInfo.boot_time ? new Date(sysInfo.boot_time).toLocaleString() : null);
            updateElement('sysinfo-server-uptime', sysInfo.server_uptime ? formatUptime(sysInfo.server_uptime) : null);
        }

        // --- API Call Functions ---
        async function fetchData() {
            try {
                const response = await fetch(`${API_BASE_URL}/data`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                currentData = data;
                updateDashboardUI();
                updateCharts();
                updateLoadControlUI();
            } catch (error) {
                console.error('Error fetching data:', error);
                currentData.connected = false;
                const statusIndicator = document.getElementById('connection-status-indicator');
                if (statusIndicator) {
                    statusIndicator.className = 'status-indicator disconnected';
                }
                const lastUpdateTime = document.getElementById('last-update-time');
                if (lastUpdateTime) {
                    lastUpdateTime.textContent = 'Error';
                }
            }
        }

        async function setParameter(paramName, value) {
            try {
                const response = await fetch(`${API_BASE_URL}/set_parameter`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ parameter: paramName, value: value })
                });
                const result = await response.json();
                if (result.success) {
                    showToast(result.message || `${paramName} actualizado correctamente`, 'success');
                    await fetchData(); 
                } else {
                    showToast(`Error: ${result.error || 'Error desconocido'}`, 'danger');
                }
            } catch (error) {
                console.error(`Error setting ${paramName}:`, error);
                showToast(`Error al enviar comando: ${error.message}`, 'danger');
            }
        }

        async function toggleLoad(hours, minutes, seconds) {
            try {
                const response = await fetch(`${API_BASE_URL}/toggle_load`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hours, minutes, seconds })
                });
                const result = await response.json();
                if (result.success) {
                    showToast(`Carga apagada por ${formatSecondsToHMS(result.duration || 0)}`, 'success');
                    // ===== AGREGAR ESTAS L√çNEAS NUEVAS =====
                    const totalSeconds = result.duration || (hours * 3600 + minutes * 60 + seconds);
                    countdownManager.totalDurationSeconds = totalSeconds;
                    countdownManager.remainingSeconds = totalSeconds;
                    countdownManager.startTime = Date.now();
                    countdownManager.scheduledEndTime = Date.now() + (totalSeconds * 1000);
                    countdownManager.startCountdownTimer();
                    // ===== FIN DE L√çNEAS NUEVAS =====
                    await fetchData();
                } else {
                    showToast(`Error al apagar carga: ${result.error || 'Error desconocido'}`, 'danger');
                }
            } catch (error) {
                console.error('Error toggling load:', error);
                showToast(`Error al enviar comando: ${error.message}`, 'danger');
            }
        }

        async function cancelTempOff() {
            try {
                const response = await fetch(`${API_BASE_URL}/cancel_temp_off`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    showToast(`Apagado temporal cancelado: ${result.message || ''}`, 'success');
                    countdownManager.stopCountdown();
                    await fetchData();
                } else {
                    showToast(`Error al cancelar apagado: ${result.error || 'Error desconocido'}`, 'danger');
                }
            } catch (error) {
                console.error('Error canceling temporary off:', error);
                showToast(`Error al enviar comando: ${error.message}`, 'danger');
            }
        }

        async function getSystemInfo() {
            try {
                const response = await fetch(`${API_BASE_URL}/system_info`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const sysInfo = await response.json();
                updateSystemInfoUI(sysInfo);
            } catch (error) {
                console.error('Error fetching system info:', error);
                showToast(`Error al obtener info del sistema: ${error.message}`, 'danger');
            }
        }

        async function getLogs(lines) {
            try {
                const response = await fetch(`${API_BASE_URL}/logs?lines=${lines}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const logData = await response.json();
                const logContent = document.getElementById('log-content');
                if (logContent) {
                    logContent.textContent = logData.logs || 'No hay logs disponibles';
                    logContent.scrollTop = logContent.scrollHeight;
                }
            } catch (error) {
                console.error('Error fetching logs:', error);
                const logContent = document.getElementById('log-content');
                if (logContent) {
                    logContent.textContent = `Error al cargar logs: ${error.message}`;
                }
                showToast(`Error al obtener logs: ${error.message}`, 'danger');
            }
        }

        async function exportConfig() {
            try {
                const response = await fetch(`${API_BASE_URL}/export_config`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const blob = await response.blob();
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'config.json';
                if (contentDisposition && contentDisposition.indexOf('filename=') !== -1) {
                    filename = contentDisposition.split('filename=')[1].replace(/['"]/g, '');
                }
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showToast('Configuraci√≥n exportada correctamente.', 'success');
            } catch (error) {
                console.error('Error exporting config:', error);
                showToast(`Error al exportar configuraci√≥n: ${error.message}`, 'danger');
            }
        }

        async function importConfig(file) {
            if (!file) {
                showToast('Por favor, selecciona un archivo.', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE_URL}/import_config`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    showToast(result.message || 'Configuraci√≥n importada correctamente', 'success');
                    if (result.errors && result.errors.length > 0) {
                        showToast(`Advertencias: ${result.errors.join(', ')}`, 'warning');
                    }
                    await fetchData();
                } else {
                    showToast(`Error al importar: ${result.error || 'Error desconocido'}`, 'danger');
                    if (result.errors && result.errors.length > 0) {
                        showToast(`Errores: ${result.errors.join(', ')}`, 'danger');
                    }
                }
            } catch (error) {
                console.error('Error importing config:', error);
                showToast(`Error de red al importar: ${error.message}`, 'danger');
            }
        }

        // --- Chart.js Initialization and Update ---
        function initializeCharts() {
            // Solo inicializar gr√°ficos si Chart.js est√° disponible
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js no est√° disponible, gr√°ficos deshabilitados');
                // Ocultar contenedores de gr√°ficos
                const chartContainers = document.querySelectorAll('.chart-container');
                chartContainers.forEach(container => {
                    container.innerHTML = '<p class="text-center text-muted">Gr√°ficos no disponibles</p>';
                });
                return;
            }

            const commonChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 },
                scales: {
                    x: {
                        type: 'category',
                        title: {
                            display: true,
                            text: 'Tiempo'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Valor'
                        }
                    }
                }
            };

            try {
                const currentCtx = document.getElementById('currentChart');
                if (currentCtx) {
                    currentChart = new Chart(currentCtx, {
                        type: 'line',
                        data: {
                            labels: chartLabels,
                            datasets: [
                                {
                                    label: 'Panel (A)',
                                    data: panelCurrentData,
                                    borderColor: 'rgb(75, 192, 192)',
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: 'Carga (A)',
                                    data: batteryCurrentData,
                                    borderColor: 'rgb(255, 99, 132)',
                                    tension: 0.1,
                                    fill: false
                                }
                            ]
                        },
                        options: {
                            ...commonChartOptions,
                            scales: {
                                ...commonChartOptions.scales,
                                y: {
                                    ...commonChartOptions.scales.y,
                                    title: {
                                        display: true,
                                        text: 'Corriente (A)'
                                    }
                                }
                            }
                        }
                    });
                }

                const voltageCtx = document.getElementById('voltageChart');
                if (voltageCtx) {
                    voltageChart = new Chart(voltageCtx, {
                        type: 'line',
                        data: {
                            labels: chartLabels,
                            datasets: [
                                {
                                    label: 'Bater√≠a (V)',
                                    data: batteryVoltageData,
                                    borderColor: 'rgb(54, 162, 235)',
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: 'Panel (V)',
                                    data: panelVoltageData,
                                    borderColor: 'rgb(255, 205, 86)',
                                    tension: 0.1,
                                    fill: false
                                }
                            ]
                        },
                        options: {
                            ...commonChartOptions,
                            scales: {
                                ...commonChartOptions.scales,
                                y: {
                                    ...commonChartOptions.scales.y,
                                    title: {
                                        display: true,
                                        text: 'Voltaje (V)'
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error initializing charts:', error);
            }
        }

        function updateCharts() {
            if (typeof Chart === 'undefined' || !currentChart || !voltageChart) {
                return;
            }

            try {
                const now = new Date();
                const timeLabel = now.toLocaleTimeString();

                // Add new data
                chartLabels.push(timeLabel);
                panelCurrentData.push((currentData.panelToBatteryCurrent || 0) / 1000);
                batteryCurrentData.push((currentData.batteryToLoadCurrent || 0) / 1000);
                batteryVoltageData.push(currentData.voltageBatterySensor2 || 0);
                panelVoltageData.push(currentData.voltagePanel || 0);

                // Remove old data if exceeding limit
                if (chartLabels.length > chartDataPoints) {
                    chartLabels.shift();
                    panelCurrentData.shift();
                    batteryCurrentData.shift();
                    batteryVoltageData.shift();
                    panelVoltageData.shift();
                }

                // Update charts
                currentChart.update('none');
                voltageChart.update('none');
            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing application...');
            
            initializeCharts();
            fetchData(); // Initial data fetch
            
            const dataInterval = setInterval(fetchData, UPDATE_INTERVAL_MS);
            
          

            // Config sections collapsible
            document.querySelectorAll('.card.config-section .card-header').forEach(header => {
                header.addEventListener('click', () => {
                    const parentCard = header.closest('.card.config-section');
                    parentCard.classList.toggle('expanded');
                    const arrow = header.querySelector('span');
                    if (arrow) {
                        arrow.textContent = parentCard.classList.contains('expanded') ? '‚ñ≤' : '‚ñº';
                    }
                });
            });

            // Update config UI when tab is shown
            const configTab = document.getElementById('configuration-tab');
            if (configTab) {
                configTab.addEventListener('click', () => {
                    setTimeout(() => {
                        updateConfigUI();
                        // AGREGAR ESTA L√çNEA DE DEBUG:
                        debugConfigValues();
                    }, 100);
                });
            }

            // Load Control handlers
            const toggleLoadBtn = document.getElementById('toggle-load-btn');
            if (toggleLoadBtn) {
                toggleLoadBtn.addEventListener('click', () => {
                    const hours = parseInt(document.getElementById('loadOffHours').value) || 0;
                    const minutes = parseInt(document.getElementById('loadOffMinutes').value) || 0;
                    const seconds = parseInt(document.getElementById('loadOffSeconds').value) || 0;
                    toggleLoad(hours, minutes, seconds);
                });
            }

            const cancelTempOffBtn = document.getElementById('cancel-temp-off-btn');
            if (cancelTempOffBtn) {
                cancelTempOffBtn.addEventListener('click', cancelTempOff);
            }

            // System & Logs handlers
            const refreshSysInfoBtn = document.getElementById('refresh-sysinfo-btn');
            if (refreshSysInfoBtn) {
                refreshSysInfoBtn.addEventListener('click', getSystemInfo);
            }

            const refreshLogsBtn = document.getElementById('refresh-logs-btn');
            if (refreshLogsBtn) {
                refreshLogsBtn.addEventListener('click', () => {
                    const lines = parseInt(document.getElementById('logLines').value) || 100;
                    getLogs(lines);
                });
            }

            // System logs tab auto-load
            let sysInfoFetched = false;
            let logsFetched = false;
            const systemLogsTab = document.getElementById('system-logs-tab');
            if (systemLogsTab) {
                systemLogsTab.addEventListener('click', () => {
                    if (!sysInfoFetched) { 
                        getSystemInfo(); 
                        sysInfoFetched = true; 
                    }
                    if (!logsFetched) { 
                        const lines = parseInt(document.getElementById('logLines').value) || 100;
                        getLogs(lines); 
                        logsFetched = true; 
                    }
                });
            }

            // Tools handlers
            const exportConfigBtn = document.getElementById('export-config-btn');
            if (exportConfigBtn) {
                exportConfigBtn.addEventListener('click', exportConfig);
            }

            const importConfigBtn = document.getElementById('import-config-btn');
            if (importConfigBtn) {
                importConfigBtn.addEventListener('click', () => {
                    const fileInput = document.getElementById('import-config-file');
                    if (fileInput && fileInput.files.length > 0) {
                        importConfig(fileInput.files[0]);
                    } else {
                        showToast('Por favor, selecciona un archivo para importar.', 'warning');
                    }
                });
            }

            console.log('Application initialized successfully');

            // Inicializar countdown manager
            countdownManager.restoreState();
            
            // Event listener para el bot√≥n de cancelar visual
            const visualCancelBtn = document.getElementById('visual-cancel-countdown-btn');
            if (visualCancelBtn) {
                visualCancelBtn.addEventListener('click', cancelTempOff);
            }
            
            // Guardar estado peri√≥dicamente
            setInterval(() => {
                countdownManager.saveState();
            }, 5000); // Cada 5 segundos
            
            // Solicitar permisos de notificaci√≥n
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Restaurar estado al recargar la p√°gina
            window.addEventListener('beforeunload', () => {
                countdownManager.saveState();
            });
            
            console.log('‚úÖ Cron√≥metro inicializado correctamente');

        
            // Inicializar night scheduler cuando se cargue el tab
            let nightSchedulerInitialized = false;
            const nightScheduleTab = document.getElementById('night-schedule-tab');
            if (nightScheduleTab) {
                nightScheduleTab.addEventListener('click', () => {
                    if (!nightSchedulerInitialized) {
                        setTimeout(() => {
                            nightScheduler.initializeUI();
                            nightScheduler.updateUI();
                            nightSchedulerInitialized = true;
                            console.log('‚úÖ Night Scheduler UI inicializado');
                        }, 100);
                    }
                });
            }
            // Forzar sincronizaci√≥n inicial despu√©s de 3 segundos
            setTimeout(() => {
                console.log('üîÑ Sincronizaci√≥n inicial de configuraci√≥n...');
                forceConfigSync();
            }, 3000);    
            // Inicializar inmediatamente el scheduler (sin UI)
            nightScheduler.startScheduler();
            
            console.log('‚úÖ Sistema de programaci√≥n nocturna cargado');
            
            // ===== CONFIGURACI√ìN DE PAR√ÅMETROS =====
            
            // Manejar el toggle de fuente DC
            const useFuenteDCCheckbox = document.getElementById('useFuenteDC');
            const fuenteDCContainer = document.getElementById('fuenteDC-container');
            
            if (useFuenteDCCheckbox && fuenteDCContainer) {
                useFuenteDCCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        fuenteDCContainer.style.display = 'block';
                    } else {
                        fuenteDCContainer.style.display = 'none';
                    }
                });
            }
            
            // Manejar botones de guardar con m√∫ltiples par√°metros
            document.querySelectorAll('.save-param-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    const params = this.dataset.params.split(',');
                    let success = true;
                    
                    for (const param of params) {
                        const element = document.getElementById(param.trim());
                        if (element) {
                            let value;
                            if (element.type === 'checkbox') {
                                value = element.checked;
                            } else {
                                value = element.value;
                            }
                            
                            try {
                                await setParameter(param.trim(), value);
                            } catch (error) {
                                success = false;
                                break;
                            }
                        }
                    }
                    
                    if (success) {
                        showToast('‚úÖ Configuraci√≥n guardada correctamente', 'success');
                        setTimeout(updateCalculatedValues, 500);
                    }
                });
            });

        });

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });

        // Handle network issues
        window.addEventListener('online', () => {
            showToast('Conexi√≥n restablecida', 'success');
        });

        window.addEventListener('offline', () => {
            showToast('Sin conexi√≥n a internet', 'warning');
        });
        // ===== FUNCIONES ADICIONALES PARA CONFIGURACI√ìN =====
        
        function updateCalculatedValues() {
            if (currentData) {
                const updateReadOnlyField = (id, value, unit = '') => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value + unit;
                };
                
                updateReadOnlyField('display-absorptionCurrentThreshold', (currentData.absorptionCurrentThreshold_mA || 0).toFixed(0), ' mA');
                updateReadOnlyField('display-currentLimitIntoFloatStage', (currentData.currentLimitIntoFloatStage || 0).toFixed(0), ' mA');
                updateReadOnlyField('display-factorDivider', currentData.factorDivider || '--');
                updateReadOnlyField('display-maxBulkHours', (currentData.maxBulkHours || 0).toFixed(1), ' h');
                updateReadOnlyField('display-LVD', (currentData.LVD || 0).toFixed(1), ' V');
                updateReadOnlyField('display-LVR', (currentData.LVR || 0).toFixed(1), ' V');
            }
        }

        function debugConfigValues() {
        console.log('üîç DEBUG: Valores actuales en la interfaz:');
        
        const elements = [
            'batteryCapacity', 'thresholdPercentage', 'maxAllowedCurrent',
            'bulkVoltage', 'absorptionVoltage', 'floatVoltage', 
            'isLithium', 'useFuenteDC', 'fuenteDC_Amps'
        ];
        
        elements.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                console.log(`${id}: ${el.type === 'checkbox' ? el.checked : el.value}`);
            } else {
                console.log(`${id}: ELEMENTO NO ENCONTRADO`);
            }
        });
        
        console.log('üîç DEBUG: Datos del servidor:');
        console.log('batteryCapacity:', currentData.batteryCapacity);
        console.log('thresholdPercentage:', currentData.thresholdPercentage);
        console.log('isLithium:', currentData.isLithium);
        console.log('useFuenteDC:', currentData.useFuenteDC);
    }

        // Forzar sincronizaci√≥n de configuraci√≥n

        function forceConfigSync() {
            console.log('üîß Forzando sincronizaci√≥n de configuraci√≥n...');
            
            // Esperar a que los datos est√©n disponibles
            if (!currentData || Object.keys(currentData).length === 0) {
                console.log('‚è≥ Esperando datos del servidor...');
                setTimeout(forceConfigSync, 1000);
                return;
            }
            
            // Forzar actualizaci√≥n de cada campo individualmente
            const batteryCapacityEl = document.getElementById('batteryCapacity');
            if (batteryCapacityEl && currentData.batteryCapacity !== undefined) {
                batteryCapacityEl.value = String(currentData.batteryCapacity);
                console.log('üîã Battery Capacity forzado a:', currentData.batteryCapacity);
            }
            
            const thresholdEl = document.getElementById('thresholdPercentage');
            if (thresholdEl && currentData.thresholdPercentage !== undefined) {
                thresholdEl.value = String(currentData.thresholdPercentage);
                console.log('üìä Threshold Percentage forzado a:', currentData.thresholdPercentage);
            }
            
            // Verificar que los valores se aplicaron correctamente
            setTimeout(() => {
                debugConfigValues();
            }, 500);
        }



        // Modificar la funci√≥n updateConfigUI existente
        const originalUpdateConfigUI = updateConfigUI;
        updateConfigUI = function() {
            if (originalUpdateConfigUI) originalUpdateConfigUI();
            updateCalculatedValues();
            
            // Actualizar visibilidad del contenedor de fuente DC
            const useFuenteDC = currentData.useFuenteDC;
            const container = document.getElementById('fuenteDC-container');
            if (container) {
                container.style.display = useFuenteDC ? 'block' : 'none';
            }
        };    
    </script>
</body>
</html>
